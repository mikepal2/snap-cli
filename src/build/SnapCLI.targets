<Project>

  <PropertyGroup Condition = "'$(AutoGenerateEntryPoint)' == 'true'">
    <!-- The location of the generated program file. -->
    <_GeneratedEntryPointFile>$(IntermediateOutputPath)$(MSBuildProjectName).Program.g$(DefaultLanguageSourceExtension)</_GeneratedEntryPointFile>
  </PropertyGroup>

  <Target Name = "_GenerateRealEntryPointType"
          BeforeTargets = "CoreCompile"
          DependsOnTargets = "PrepareForBuild;CoreGenerateSnapCliProgramFile"
          Condition = "'$(AutoGenerateEntryPoint)' == 'true'">
    <PropertyGroup>
      <StartupObject>AutoGeneratedProgram</StartupObject>
    </PropertyGroup>
  </Target>

  <Target Name = "CoreGenerateSnapCliProgramFile"
          Condition = "'$(Language)' == 'C#' Or '$(Language)' == 'VB'"
          Inputs = "$(MSBuildAllProjects)"
          Outputs = "$(_GeneratedEntryPointFile)">

      <PropertyGroup Condition = "'$(Language)' == 'C#'">
         <_GeneratedProgramFileContent>

<![CDATA[
        // <auto-generated>This file was created automatically</auto-generated>
        using System.Runtime.CompilerServices;
        using System.Threading.Tasks;

        [CompilerGenerated]
        internal class AutoGeneratedProgram
        {
          public static async Task<int> Main(string[] args)
          {
            return await SnapCLI.CLI.RunAsync(args);
          }
        }
]]>

       </_GeneratedProgramFileContent>

    </PropertyGroup>

    <PropertyGroup Condition = "'$(Language)' == 'VB'">
      <_GeneratedProgramFileContent>

        <![CDATA[
        Imports System
        Imports System.Diagnostics
        Imports System.Runtime.CompilerServices
        Imports System.Threading.Tasks

        ' <auto-generated>This file was created automatically</auto-generated>
        <CompilerGenerated()>
        Friend Class AutoGeneratedProgram

          Public Shared Async Function Main(args As String()) As Task(Of Integer)
            Return Await SnapCLI.CLI.RunAsync(args)
          End Function
        End Class
]]>

      </_GeneratedProgramFileContent>

    </PropertyGroup>

    <WriteLinesToFile File = "$(_GeneratedEntryPointFile)"
                      Overwrite = "true"
                      Lines = "$([MSBuild]::Escape($(_GeneratedProgramFileContent)))"
                      Encoding = "Unicode"/>

    <ItemGroup>
      <Compile Include = "$(_GeneratedEntryPointFile)" />
    </ItemGroup>
  </Target>
</Project>
